<script lang="ts">
  import { onMount } from 'svelte';

  const steps = [
    {
      id: "book",
      title: "Book Your Appointment",
      text: "Getting started is easy. Book online, call us at 519-759-0049, or use our live chat. We offer flexible scheduling including same-day emergency appointments when you need urgent care.",
      tags: ["Online Booking", "Phone Appointments", "Live Chat Support", "Same-Day Emergency", "Flexible Scheduling", "New Patient Welcome"],
      graphic: "lines"
    },
    {
      id: "welcome",
      title: "Feel Welcome & Comfortable",
      text: "From the moment you arrive, our familiar faces and personalized approach help you feel at ease. We take time to understand your unique needs, concerns, and dental goalsâ€”especially if you experience dental anxiety.",
      tags: ["Personalized Greeting", "Anxiety Management", "Comfort-Focused Care", "Patient History Review", "Treatment Discussion", "Questions Welcome"],
      graphic: "curve"
    },
    {
      id: "treatment",
      title: "Receive Expert Care",
      text: "Our experienced team uses modern technology and gentle techniques to provide comprehensive dental care. We explain every step and offer various treatment options to fit your needs and budget.",
      tags: ["Comprehensive Exams", "Modern Technology", "Gentle Techniques", "Treatment Options", "Budget-Friendly Plans", "Quality Care"],
      graphic: "circle-top"
    },
    {
      id: "care",
      title: "Ongoing Support & Care",
      text: "Your relationship with us doesn't end when you leave. We provide follow-up care, answer questions via our 'Ask Dr. D' feature, and help you maintain your smile with preventive care and regular checkups.",
      tags: ["Follow-Up Care", "Ask Dr. D", "Preventive Plans", "Regular Checkups", "Ongoing Support", "Family Continuity"],
      graphic: "circle-waves"
    }
  ];

  let activeStep = 0;
  let sectionRef: HTMLElement;

  onMount(() => {
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const index = steps.findIndex(step => step.id === entry.target.id);
            if (index !== -1) {
              activeStep = index;
            }
          }
        });
      },
      {
        root: null,
        rootMargin: "-20% 0px -20% 0px", // Trigger when element is in the middle 60% of viewport
        threshold: 0.5
      }
    );

    steps.forEach((step) => {
      const el = document.getElementById(step.id);
      if (el) observer.observe(el);
    });

    return () => observer.disconnect();
  });
</script>

<section class="bg-[oklch(0.141_0.005_285.823)] text-white py-24 px-6 md:px-12 relative" bind:this={sectionRef}>
  <div class="max-w-screen-2xl mx-auto flex flex-col md:flex-row gap-12">
    
    <!-- Sticky Navigation -->
    <div class="md:w-1/2 md:h-[calc(100vh-6rem)] md:sticky md:top-24 flex flex-col justify-center">
      <div class="space-y-8">
        {#each steps as step, i}
          <div class="transition-opacity duration-500 {i === activeStep ? 'opacity-100' : 'opacity-30'}">
            <p class="text-xl md:text-2xl font-light mb-1">Your dental journey:</p>
            <h2 class="text-2xl md:text-3xl font-bold">{step.title}</h2>
          </div>
        {/each}
      </div>
    </div>

    <!-- Scrollable Cards -->
    <div class="md:w-1/2 space-y-24 pt-12 md:pt-0">
      {#each steps as step, i}
        <div class="bg-white text-black rounded-lg p-8 md:p-12 min-h-[600px] flex flex-col justify-between scroll-mt-32" id={step.id}>
          <!-- Graphic Placeholder -->
          <div class="flex-1 flex items-center justify-center mb-8 border border-gray-100 rounded bg-gray-50 min-h-[200px]">
             {#if step.graphic === 'lines'}
                <svg width="200" height="100" viewBox="0 0 200 100" class="opacity-50">
                    <line x1="20" y1="20" x2="20" y2="80" stroke="black" stroke-width="1"/>
                    <line x1="40" y1="20" x2="40" y2="80" stroke="black" stroke-width="1"/>
                    <line x1="60" y1="20" x2="60" y2="80" stroke="black" stroke-width="1"/>
                    <line x1="80" y1="20" x2="80" y2="80" stroke="black" stroke-width="1"/>
                    <line x1="100" y1="20" x2="100" y2="80" stroke="black" stroke-width="1"/>
                </svg>
             {:else if step.graphic === 'curve'}
                <svg width="200" height="100" viewBox="0 0 200 100" class="opacity-50">
                    <path d="M20 80 Q 100 0 180 80" fill="none" stroke="black" stroke-width="1"/>
                </svg>
             {:else if step.graphic === 'circle-top'}
                <svg width="200" height="100" viewBox="0 0 200 100" class="opacity-50">
                    <circle cx="100" cy="100" r="60" fill="none" stroke="black" stroke-width="1"/>
                    <circle cx="100" cy="100" r="40" fill="none" stroke="black" stroke-width="1"/>
                </svg>
             {:else}
                <svg width="200" height="100" viewBox="0 0 200 100" class="opacity-50">
                    <ellipse cx="100" cy="50" rx="80" ry="20" fill="none" stroke="black" stroke-width="1"/>
                    <ellipse cx="100" cy="50" rx="60" ry="15" fill="none" stroke="black" stroke-width="1"/>
                    <ellipse cx="100" cy="50" rx="40" ry="10" fill="none" stroke="black" stroke-width="1"/>
                </svg>
             {/if}
          </div>

          <div>
             <p class="text-lg leading-relaxed mb-8">{step.text}</p>

             <div class="grid grid-cols-2 gap-4 text-xs font-medium text-gray-600">
               {#each step.tags as tag}
                 <div class="flex items-center gap-2">
                   <span class="w-1.5 h-1.5 bg-black rounded-full shrink-0"></span>
                   {tag}
                 </div>
               {/each}
             </div>
          </div>
        </div>
      {/each}
    </div>
  </div>
</section>
